{%- set network_interface_ipv4 = hostvars[inventory_hostname]['ansible_' + network_interface]['ipv4']['address'] | default(hostvars[inventory_hostname]['ansible_default_ipv4']['address']) -%}
consul {
  # Point `consul` to `consul.service.consul`
  rewrite name exact consul consul.service.consul
  forward . {{ groups['controlplane'] | map('extract', hostvars, ['ansible_' + network_interface, 'ipv4', 'address']) | list | join(':8600 ') }}:8600

  log
  errors
}

. {
  # Point all `.demo` queries to localhost
  template IN A demo {
    answer "{% raw %}{{ .Name }}{% endraw %} 60 IN A {{ network_interface_ipv4 }}"
    fallthrough
  }

  forward . tls://1.1.1.1 tls://1.0.0.1 {
   tls_servername cloudflare-dns.com
   health_check 5s
  }

  cache 30
  log
  errors
}
